from flask import Flask, render_template_string, url_for
import win32com.client
import pythoncom

app = Flask(__name__)

# Function to fetch health status emails from Outlook
def fetch_health_status_emails():
    pythoncom.CoInitialize()
    outlook = win32com.client.Dispatch("Outlook.Application").GetNamespace("MAPI")
    inbox = outlook.GetDefaultFolder(6)  # Access Inbox
    messages = inbox.Items
    messages.Sort("[ReceivedTime]", True)  # Sort by received time

    emails = []
    for message in messages:
        if message.Class == 43 and 'UK DPaaS Platform Health Status' in message.Subject:
            email_data = {
                'subject': message.Subject,
                'received_time': message.ReceivedTime.strftime('%Y-%m-%d %H:%M:%S'),
                'body': message.HTMLBody if message.BodyFormat == 2 else message.Body
            }
            emails.append(email_data)
    pythoncom.CoUninitialize()
    return emails

# Route to display the email list
@app.route('/')
def list_emails():
    emails = fetch_health_status_emails()
    return render_template_string(open('email_template.html').read(), emails=emails)

# Route to display individual email
@app.route('/email/<int:email_id>')
def show_email(email_id):
    emails = fetch_health_status_emails()
    if email_id < len(emails):
        email = emails[email_id]
        return render_template_string(open('email_template.html').read(), email=email)
    else:
        return "Email not found", 404

if __name__ == '__main__':
    app.run(debug=True)
